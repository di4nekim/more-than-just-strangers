# API Endpoints Testing

This directory contains comprehensive tests for all API endpoints in the application.

## Test Files

### 1. `endpoints.test.js` - Unit Tests
Comprehensive unit tests that mock all external dependencies (Firebase, DynamoDB, etc.) and test the API endpoint logic in isolation.

**Features:**
- Tests all API endpoints with mocked responses
- Validates authentication requirements
- Tests error handling scenarios
- Tests response structure and data validation
- Fast execution (no external dependencies)

**Run with:**
```bash
npm run test:api:endpoints
```

### 2. `integration.test.js` - Integration Tests
Integration tests that make real HTTP requests to a running development server.

**Features:**
- Tests actual API endpoints
- Validates real server responses
- Tests authentication flows
- Requires development server to be running

**Run with:**
```bash
# Start development server first
npm run dev

# In another terminal, run integration tests
npm run test:api:integration:manual
```

## Available API Endpoints

### Health Endpoint
- **GET** `/api/health` - Returns system health status
- **Response:** Health status, services status, version, environment

### Chat Endpoints
- **GET** `/api/chat/start` - Health check for chat start service
- **POST** `/api/chat/start` - Start a new chat (requires authentication)
- **GET** `/api/chat/[chatId]` - Get chat details (requires authentication)
- **GET** `/api/chat/[chatId]/messages` - Get chat messages (requires authentication)
- **POST** `/api/chat/[chatId]/messages` - Not allowed (use WebSocket instead)
- **POST** `/api/chat/[chatId]/end` - End a chat (requires authentication)
- **GET** `/api/chat/[chatId]/validate` - Validate chat access (requires authentication)

### User Endpoints
- **GET** `/api/user/profile` - Get user profile (requires authentication)
- **PATCH** `/api/user/profile` - Update user profile (requires authentication)
- **GET** `/api/user/active-chat` - Get active chat status (requires authentication)
- **GET** `/api/user/[userId]/chat-context` - Get user chat context (requires authentication)

### Auth Endpoints
- **GET** `/api/auth/verify` - Health check for auth verification service
- **POST** `/api/auth/verify` - Verify Firebase token

## Test Scripts

### Quick Health Check
Test the health endpoint manually:
```bash
npm run test:api:health
```

### Unit Tests Only
Run unit tests (fast, no server required):
```bash
npm run test:api:endpoints
```

### All API Tests
Run all API tests (unit + integration):
```bash
npm run test:api
```

### Integration Tests with Auto Server Start
Automatically start development server and run integration tests:
```bash
npm run test:api:integration
```

### Watch Mode
Run tests in watch mode for development:
```bash
npm run test:api:watch
```

## Authentication

All protected endpoints require a valid Firebase JWT token in the Authorization header:
```
Authorization: Bearer <firebase-jwt-token>
```

The tests use mock JWT tokens created by the `jwt-helper.js` utility.

## Error Handling

The tests validate proper error handling for:
- Missing authentication tokens (401)
- Invalid authentication tokens (401)
- Service unavailability (503)
- Invalid request data (400)
- Unauthorized access (403)
- Method not allowed (405)

## Test Coverage

The tests cover:
- ✅ All API endpoints
- ✅ Authentication requirements
- ✅ Request/response validation
- ✅ Error handling
- ✅ Edge cases
- ✅ Response structure validation

## Development

### Adding New Endpoints
1. Create the endpoint in `src/app/api/`
2. Add unit tests to `endpoints.test.js`
3. Add integration tests to `integration.test.js`
4. Update this README

### Running Tests During Development
```bash
# Run unit tests in watch mode
npm run test:api:watch

# Run specific test file
npm test -- __tests__/api/endpoints.test.js

# Run with coverage
npm test -- __tests__/api --coverage
```

## Troubleshooting

### Integration Tests Failing
- Make sure development server is running: `npm run dev`
- Check if port 3000 is available
- Verify Firebase configuration for auth tests

### Unit Tests Failing
- Check if all mocks are properly configured
- Verify test data matches expected response structure
- Ensure all dependencies are installed

### Health Endpoint Not Responding
- Check if Next.js server is running
- Verify the health endpoint route exists
- Check server logs for errors

## Test Data

The tests use consistent test data:
- **Test User ID:** `test-user-123`
- **Test Email:** `test@example.com`
- **Test Chat ID:** `test-chat-123`
- **Test Token:** Generated by `createFirebaseTestJWT()`

## Mock Configuration

The unit tests mock:
- Firebase Admin SDK
- DynamoDB client
- External HTTP requests
- Environment variables

This ensures tests run quickly and don't depend on external services. 